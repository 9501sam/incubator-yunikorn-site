(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{122:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return p}));var i=n(2),a=n(6),r=(n(0),n(245)),o=["components"],l={id:"k8shim",title:"Kubernetes Shim Design"},s={unversionedId:"design/k8shim",id:"design/k8shim",isDocsHomePage:!1,title:"Kubernetes Shim Design",description:"\x3c!--",source:"@site/docs/design/k8shim.md",slug:"/design/k8shim",permalink:"/docs/next/design/k8shim",version:"current",sidebar:"docs",previous:{title:"Scheduler cache removal design",permalink:"/docs/next/design/cache_removal"},next:{title:"Cross Queue Preemption",permalink:"/docs/next/design/cross_queue_preemption"}},c=[{value:"The Kubernetes shim",id:"the-kubernetes-shim",children:[]},{value:"The admission controller",id:"the-admission-controller",children:[{value:"Admission controller deployment",id:"admission-controller-deployment",children:[]}]}],u={rightToc:c};function p(e){var t=e.components,n=Object(a.a)(e,o);return Object(r.b)("wrapper",Object(i.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"Github repo: ",Object(r.b)("a",{parentName:"p",href:"https://github.com/apache/incubator-yunikorn-k8shim"},"https://github.com/apache/incubator-yunikorn-k8shim")),Object(r.b)("p",null,"Please read the ",Object(r.b)("a",{parentName:"p",href:"/docs/next/design/architecture"},"architecture")," doc before reading this one, you will need to understand\nthe 3 layer design of YuniKorn before getting to understand what is the Kubernetes shim."),Object(r.b)("h2",{id:"the-kubernetes-shim"},"The Kubernetes shim"),Object(r.b)("p",null,"The YuniKorn Kubernetes shim is responsible for talking to Kubernetes, it is responsible for translating the Kubernetes\ncluster resources, and resource requests via scheduler interface and send them to the scheduler core.\nAnd when a scheduler decision is made, it is responsible for binding the pod to the specific node. All the communication\nbetween the shim and the scheduler core is through the scheduler-interface."),Object(r.b)("h2",{id:"the-admission-controller"},"The admission controller"),Object(r.b)("p",null,"The admission controller runs in a separate pod, it runs a\n",Object(r.b)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook"},"mutation webhook"),"\nand a ",Object(r.b)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook"},"validation webhook"),", where:"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"mutation webhook")," mutates pod spec by:",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Adding ",Object(r.b)("inlineCode",{parentName:"li"},"schedulerName: yunikorn"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"By explicitly specifying the scheduler name, the pod will be scheduled by YuniKorn scheduler."))),Object(r.b)("li",{parentName:"ul"},"Adding ",Object(r.b)("inlineCode",{parentName:"li"},"applicationId")," label",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"When a label ",Object(r.b)("inlineCode",{parentName:"li"},"applicationId")," exists, reuse the given applicationId."),Object(r.b)("li",{parentName:"ul"},"When a label ",Object(r.b)("inlineCode",{parentName:"li"},"spark-app-selector")," exists, reuse the given spark app ID."),Object(r.b)("li",{parentName:"ul"},"Otherwise, assign a generated application ID for this pod, using convention: ",Object(r.b)("inlineCode",{parentName:"li"},"yunikorn-<namespace>-autogen"),". This is unique per namespace."))),Object(r.b)("li",{parentName:"ul"},"Adding ",Object(r.b)("inlineCode",{parentName:"li"},"queue")," label",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"When a label ",Object(r.b)("inlineCode",{parentName:"li"},"queue")," exists, reuse the given queue name. Note, if placement rule is enabled, values set in the label is ignored."),Object(r.b)("li",{parentName:"ul"},"Otherwise, adds ",Object(r.b)("inlineCode",{parentName:"li"},"queue: root.default")))),Object(r.b)("li",{parentName:"ul"},"Adding ",Object(r.b)("inlineCode",{parentName:"li"},"disableStateAware")," label",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"If pod was assigned a generated applicationId by the admission controller, also set ",Object(r.b)("inlineCode",{parentName:"li"},"disableStateAware: true"),". This causes the generated application\nto immediately transition from the ",Object(r.b)("inlineCode",{parentName:"li"},"Starting")," to ",Object(r.b)("inlineCode",{parentName:"li"},"Running")," state so that it will not block other applications."))))),Object(r.b)("li",{parentName:"ol"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"validation webhook")," validates the configuration set in the configmap",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"This is used to prevent writing malformed configuration into the configmap."),Object(r.b)("li",{parentName:"ul"},"The validation webhook calls scheduler ",Object(r.b)("a",{parentName:"li",href:"/docs/next/api/scheduler#configuration-validation"},"validation REST API")," to validate configmap updates.")))),Object(r.b)("h3",{id:"admission-controller-deployment"},"Admission controller deployment"),Object(r.b)("p",null,"Currently, the deployment of the admission-controller is done as a ",Object(r.b)("inlineCode",{parentName:"p"},"post-start")," hook in the scheduler deployment, similarly, the\nuninstall is done as a ",Object(r.b)("inlineCode",{parentName:"p"},"pre-stop")," hook. See the related code ",Object(r.b)("a",{parentName:"p",href:"https://github.com/apache/incubator-yunikorn-release/blob/56e580af24ed3433e7d73d9ea556b19ad7b74337/helm-charts/yunikorn/templates/deployment.yaml#L80-L85"},"here"),".\nDuring the installation, it is expected to always co-locate the admission controller with the scheduler pod, this is done\nby adding the pod-affinity in the admission-controller pod, like:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'podAffinity:\n  requiredDuringSchedulingIgnoredDuringExecution:\n    - labelSelector:\n      matchExpressions:\n      - key: component\n        operator: In\n        values:\n        - yunikorn-scheduler\n      topologyKey: "kubernetes.io/hostname"\n')),Object(r.b)("p",null,"it also tolerates all the taints in case the scheduler pod has some toleration set."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-yaml"},'tolerations:\n- operator: "Exists"\n')))}p.isMDXComponent=!0},245:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var i=n(0),a=n.n(i);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=a.a.createContext({}),u=function(e){var t=a.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=u(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),d=i,m=p["".concat(o,".").concat(d)]||p[d]||b[d]||r;return n?a.a.createElement(m,l(l({ref:t},c),{},{components:n})):a.a.createElement(m,l({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var c=2;c<r;c++)o[c]=n[c];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);